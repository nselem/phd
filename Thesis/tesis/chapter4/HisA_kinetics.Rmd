---
output: pdf_document
---
  ---
title: "TrpF_kinetics"
author: "NellySelem"
date: "May 18, 2017"
output: pdf_document
---


## Process data
```{r include_reedtemplates_TrpFkinetics, include = FALSE}
# This chunk ensures that the reedtemplates package is installed and loaded
# This reedtemplates package includes the template files for the thesis and also
# two functions used for labeling and referencing
if(!require(devtools))
  install.packages("devtools", repos = "http://cran.rstudio.com")

if(!require(reedtemplates)){
  library(devtools)
  devtools::install_github("ismayc/reedtemplates")
  }
library(reedtemplates)
```

```{r load_pkgs_TrpFkinetics, message = FALSE,echo=FALSE}
# List of packages required for this analysis
pkg <- c("dplyr", "ggplot2", "knitr", "devtools","RColorBrewer")
# Check if packages are not installed and assign the
# names of the packages not installed to the variable new.pkg
new.pkg <- pkg[!(pkg %in% installed.packages())]
# If there are any packages in the list that aren't installed,
# install them
if (length(new.pkg))
  install.packages(new.pkg, repos = "http://cran.rstudio.com")
# Load packages
library(dplyr)
library(plyr)
library(reshape) ## melt
library(ggplot2)
library(knitr)
library(RColorBrewer)
hm.palette <- colorRampPalette(rev(brewer.pal(11, 'Spectral')), space='Lab')  
library(genstats) ## Next libraries are for coursera
library(devtools)
library(Biobase)
library(scales) # 
library(xlsx) # For save data on excel
library(knitr)
library(drc) # for fitting Michaelis Menten model
library(ggplot2) # for drawing

```

```{r Cinetics}
#First I saved file as scv tablar separated    
#perl -p -i -e 's/,/\t/g' PROFAR_scoe1.csv   
#An cut it to obtain just data  
#tail -n +39 PROFAR_scoe1.csv | head -n-3 > PROFAR_scoe1.data  
#perl -p -i -e 's/\sNr\.|\s\[\w*\]|\.\s\[.*\]//g' PROFAR_scoe1.data
#tablePROFAR <- read.table("chapter2/cineticas/PROFAR_scoe1.data",header=TRUE, sep="\t") 
tablePROFAR <- read.table("cineticas/09062017_profar.data",header=TRUE, sep="\t") 
PROFAR_Con<-c(100,75,60,50,40,20,10,0)

## visualising full data
tablePROFAR$Temp<-NULL
tablePROFAR$Cycle<-NULL

PROFARassay.m <- melt(tablePROFAR,id="Time")
plot(PROFARassay.m$Time, PROFARassay.m$value, col=PROFARassay.m$variable,  xlab="Time [s]",ylab="Absorbance 300nm", pch=19,bty='L')
par(xpd = TRUE)
legend("right", legend = rev(unique(PROFARassay.m$variable)), col = rev(unique(PROFARassay.m$variable)),pch=19,bg="white")

```

```{r BeerLambertUnits}

#To obtain kinetic parameters Beer-Lambert law must be used on all data: Absorbance equal to extintion
#coefficient (L/M*cm) times pole large on cm times solute concentration (M/L)
#A= elC
#ProFAR extintion coefficient: 6069 L/M *cm a 300 nm
#C=6069 (L/M cm )/A
#Once data are transformed from absorbance to concentration units, initial velocity V 0 can be computed
#(Concentration/time). For each ProFAR concentration an initial velocity will be obtained and Michaleis
#Menden parameters can be used. Pole longitud l will be considered as 1 on a fix volume of 160ul (Ernesto) (170 ul) Lianet

PROFARcon = function(y){6069/y}

PROFARassay2<- PROFARcon(tablePROFAR)
PROFARassay2["Time"]<- tablePROFAR["Time"]

### End selection of columns
PROFARassay2$Cycle <- NULL
PROFARassay2$Temp <- NULL


#PROFARassay2<-PROFARassay2[, !(colnames(PROFARassay2) %in% c("C62uM"))]

PROFARassay2.m <- melt(PROFARassay2,id="Time")
plot(PROFARassay2.m$Time, PROFARassay2.m$value, col=PROFARassay2.m$variable, xlab="Time", ylab="PROFAR BeerLambert",pch=19)
par(new=TRUE)
legend("right", legend = unique(PROFARassay2.m$variable), col = unique(PROFARassay2.m$variable), pch=19,box.lwd=0, bg="white")
##

```

```{r slopes}
 ##pendientes (slopes) of linear part of the curve
# time when TrpF is added
cuttime<-0
maxtime=620

PROFARassay2Time<-PROFARassay2[which(PROFARassay2$Time >= cuttime & PROFARassay2$Time <= maxtime),]

## removi columnas que se salian del margen de medicion
#PROFARassay2Time<-PROFARassay2Time[, !(colnames(PROFARassay2Time) %in% c("C62uM"))]

# vector with slopes for each dataset
V0 <- apply(PROFARassay2Time, 2, function(x) coefficients(lm(x ~ PROFARassay2Time$Time,na.action=na.omit))[2])

PROFARassay2Time.m <- melt(PROFARassay2Time,id="Time")
plot(PROFARassay2Time.m$Time, PROFARassay2Time.m$value, col=PROFARassay2Time.m$variable,xlab="Time", ylab="URF PROFAR uM", pch=19, xlim=c(cuttime-50,maxtime+50),bty='L')

V1 <- apply(PROFARassay2Time[,2:ncol(PROFARassay2Time)], 2, function(x) coefficients(lm(x ~ PROFARassay2Time$Time,na.action=na.omit)))
apply(V1, 2, function(x) {abline(x, col = PROFARassay2Time.m$variable)  })
par(xpd = TRUE)
slopeText2="m ="
slopeText<-paste(slopeText2,rev(round(V0[-1],digits=6)),rev(names(V0[-1])))
legend(450,100, legend = slopeText, col = rev(unique(PROFARassay2Time.m$variable)), pch=19,box.lwd=0, bg="white")

## get relevant velocities and get correspondent concentrations
## V0 or slopes are on [PROFAR]uM/s 
# slopes stores the slope, with TRUE , FALSE the desired enzyme can be selected, One more than one is tested on a plate always check if it is the desired one.
slopes=(round(V0[-1],digits=6))[c(TRUE)]
concentration<-as.matrix(PROFARassay2Time[1,names(slopes)])
#slopes
#concentration
slopes=as.matrix((round(V0[-1],digits=6))[c(TRUE)])
row.names(slopes) <- NULL 
slopes<-c(slopes)## plot on r base

slopes
# in concentration I stored the inital substrate concentration  
row.names(concentration) <- NULL 
concentration<-c(concentration)
slopes
concentration
```

```#{r interpolar michaelis-menden}
## interpolar michaelis-menden

#https://rpubs.com/RomanL/6752
#https://davetang.org/muse/2013/05/17/fitting-a-michaelis-mentens-curve-using/
#S <-concentration
## from highest to lower concentration
S <-PROFAR_Con
#S<-S[-length(S)]
#S<-S[-1]
v<-slopes
#v<-slopes[-length(slopes)]
#v <-slopes[c(TRUE,FALSE)]
v<--1*v
S
v
mm <- data.frame(S,v)                                                                                 
model.drm <- drm(v ~ S, data = mm, fct = MM.2())
summary(model.drm)
## first value equal km
## second value = vm
Km=coefficients(model.drm)[1]
Vmax=2*coefficients(model.drm)[2]
Enzyme=2.5 #2.5uM
Kcat=Vmax*Enzyme  
Km
Vmax
Kcat
mml <- data.frame(S = seq(0, max(mm$S), length.out = 100))
mml$v <- predict(model.drm, newdata = mml)


## plot on r base
plot(mm,log='',xlim=c(0,max(mm$S)), ylim=c(0,max(mm$v)), xlab="Reads", ylab="Transcripts")

##plot on ggplot
ggplot(mm, aes(x = S, y = v)) + theme_bw() + xlab("Concentration [uM]") + ylab("Speed [d[PROFAR]uM/s]") + ggtitle("Michaelis-Menten kinetics") +  geom_point(alpha = 0.5) + geom_line(data = mml, aes(x = S, y = v), colour = "red")

ggsave("mm.pdf", width = 6, height = 4)
```

